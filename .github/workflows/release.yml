name: Release
on:
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}

permissions: {}

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
      id-token: write
      pull-requests: write
    outputs:
      changed-apps: ${{ steps.detect.outputs.apps }}
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        uses: ./.github/actions/setup
      - name: Create Release Pull Request
        id: changeset
        uses: changesets/action@v1
        with:
          version: pnpm changeset-version
          publish: pnpm changeset-publish
          commitMode: github-api
          createGithubReleases: true
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
      - id: detect
        if: steps.changeset.outputs.published == 'true'
        run: |
          APPS=$(echo '${{ steps.changeset.outputs.publishedPackages }}' \
            | jq -r '.[].name | sub("^@sideline/"; "")' \
            | while read -r name; do
                if [[ -d "applications/$name" ]]; then echo "$name"; fi
              done \
            | jq -R -s -c 'split("\n") | map(select(. != ""))')
          echo "apps=$APPS" >> "$GITHUB_OUTPUT"
  docker:
    name: Docker (${{ matrix.app }})
    needs: release
    if: needs.release.outputs.changed-apps != '' && needs.release.outputs.changed-apps != '[]'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        app: ${{ fromJson(needs.release.outputs.changed-apps) }}
    steps:
      - uses: actions/checkout@v4

      - name: Get package.json data
        id: package
        run: |
          VERSION="$(cat applications/${{ matrix.app }}/package.json | jq '.version')"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/${{ matrix.app }}
          tags: |
            type=raw,value=${{ steps.package.outputs.version }}
            type=ref,event=branch
            type=ref,event=pr
            type=sha

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: applications/${{ matrix.app }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
